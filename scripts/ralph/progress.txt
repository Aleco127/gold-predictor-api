# Ralph Progress Log
Started: 2026-01-18T19:15:00.000Z
Feature: Gold Predictor v2 - Advanced Trading Features
Branch: ralph/gold-predictor-v2

## Codebase Patterns

### Project Structure
- FastAPI server in src/api/server.py
- ML models in src/models/
- Data connectors in src/data/
- Features in src/features/
- Config in src/config.py

### Key Files
- src/api/server.py - Main API endpoints
- src/data/capital_connector.py - Capital.com trading API
- src/models/ensemble.py - LSTM + XGBoost ensemble
- src/config.py - Settings and environment variables

### Testing
- Run with: python -m pytest tests/
- Typecheck with: python -m mypy src/

## Iteration Log

### Iteration 1 - US-009: Daily Loss Limit Protection
**Completed:** 2026-01-18

**Changes Made:**
- Created `src/trading/__init__.py` - Trading module init
- Created `src/trading/risk_manager.py` - Full RiskManager class with:
  - Daily P&L tracking
  - Trade recording
  - Daily loss limit enforcement (3% default)
  - Max daily trades limit (50 default)
  - Auto-reset at midnight UTC
- Updated `src/config.py` - Added risk management settings
- Updated `src/api/server.py` - Added risk management integration:
  - RiskManager initialized in lifespan
  - `/api/daily-stats` endpoint
  - `/api/risk-status` endpoint
  - `/api/record-pnl` endpoint
  - `/api/update-balance` endpoint
  - Risk check integrated into `/predict-and-trade`

**Patterns Discovered:**
- Use dataclasses for simple data containers (Trade, DailyStats)
- Use datetime.now(timezone.utc) for consistent UTC timestamps
- Global instances initialized in lifespan function
- Pydantic BaseModel for API response models

**Notes:**
- Risk manager blocks trading when daily loss >= daily_loss_limit_pct of account balance
- P&L should be recorded when positions close (not when opened)

### Iteration 2 - US-010: Volatility-Adjusted Position Sizing
**Completed:** 2026-01-18

**Changes Made:**
- Updated `src/config.py` - Added position sizing settings:
  - base_position_size, max_position_size, min_position_size
  - volatility_high_threshold (1.5x), volatility_low_threshold (0.7x)
  - volatility_lookback (20 periods)
- Updated `src/trading/risk_manager.py`:
  - Added PositionSizeResult dataclass
  - Added calculate_position_size() method using ATR ratio
  - Added get_position_sizing_config() method
- Updated `src/trading/__init__.py` - Exported PositionSizeResult
- Updated `src/api/server.py`:
  - Added PositionSizeResponse and PositionSizingConfigResponse models
  - Updated RiskManager init with position sizing params
  - Updated /predict-and-trade with use_volatility_sizing param
  - Added /api/position-sizing-config endpoint
  - Added /api/calculate-position-size endpoint

**Patterns Discovered:**
- ATR ratio = current_atr / average_atr(lookback)
- High volatility (>1.5x): adjustment_factor = 1/ratio (reduce size)
- Low volatility (<0.7x): adjustment_factor = min(1/ratio, 2.0) (increase size, cap at 2x)
- Always apply min/max limits after calculation

**Notes:**
- Position size is rounded to 2 decimal places for standard lot sizing
- Volatility sizing can be disabled with use_volatility_sizing=False
