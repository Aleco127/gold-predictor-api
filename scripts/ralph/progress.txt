# Ralph Progress Log
Started: 2026-01-18T19:15:00.000Z
Feature: Gold Predictor v2 - Advanced Trading Features
Branch: ralph/gold-predictor-v2

## Codebase Patterns

### Project Structure
- FastAPI server in src/api/server.py
- ML models in src/models/
- Data connectors in src/data/
- Features in src/features/
- Config in src/config.py

### Key Files
- src/api/server.py - Main API endpoints
- src/data/capital_connector.py - Capital.com trading API
- src/models/ensemble.py - LSTM + XGBoost ensemble
- src/config.py - Settings and environment variables

### Testing
- Run with: python -m pytest tests/
- Typecheck with: python -m mypy src/

## Iteration Log

### Iteration 1 - US-009: Daily Loss Limit Protection
**Completed:** 2026-01-18

**Changes Made:**
- Created `src/trading/__init__.py` - Trading module init
- Created `src/trading/risk_manager.py` - Full RiskManager class with:
  - Daily P&L tracking
  - Trade recording
  - Daily loss limit enforcement (3% default)
  - Max daily trades limit (50 default)
  - Auto-reset at midnight UTC
- Updated `src/config.py` - Added risk management settings
- Updated `src/api/server.py` - Added risk management integration:
  - RiskManager initialized in lifespan
  - `/api/daily-stats` endpoint
  - `/api/risk-status` endpoint
  - `/api/record-pnl` endpoint
  - `/api/update-balance` endpoint
  - Risk check integrated into `/predict-and-trade`

**Patterns Discovered:**
- Use dataclasses for simple data containers (Trade, DailyStats)
- Use datetime.now(timezone.utc) for consistent UTC timestamps
- Global instances initialized in lifespan function
- Pydantic BaseModel for API response models

**Notes:**
- Risk manager blocks trading when daily loss >= daily_loss_limit_pct of account balance
- P&L should be recorded when positions close (not when opened)

### Iteration 2 - US-010: Volatility-Adjusted Position Sizing
**Completed:** 2026-01-18

**Changes Made:**
- Updated `src/config.py` - Added position sizing settings:
  - base_position_size, max_position_size, min_position_size
  - volatility_high_threshold (1.5x), volatility_low_threshold (0.7x)
  - volatility_lookback (20 periods)
- Updated `src/trading/risk_manager.py`:
  - Added PositionSizeResult dataclass
  - Added calculate_position_size() method using ATR ratio
  - Added get_position_sizing_config() method
- Updated `src/trading/__init__.py` - Exported PositionSizeResult
- Updated `src/api/server.py`:
  - Added PositionSizeResponse and PositionSizingConfigResponse models
  - Updated RiskManager init with position sizing params
  - Updated /predict-and-trade with use_volatility_sizing param
  - Added /api/position-sizing-config endpoint
  - Added /api/calculate-position-size endpoint

**Patterns Discovered:**
- ATR ratio = current_atr / average_atr(lookback)
- High volatility (>1.5x): adjustment_factor = 1/ratio (reduce size)
- Low volatility (<0.7x): adjustment_factor = min(1/ratio, 2.0) (increase size, cap at 2x)
- Always apply min/max limits after calculation

**Notes:**
- Position size is rounded to 2 decimal places for standard lot sizing
- Volatility sizing can be disabled with use_volatility_sizing=False

### Iteration 3 - US-007: Trailing Stop-Loss Implementation
**Completed:** 2026-01-18

**Changes Made:**
- Updated `src/config.py` - Added trailing stop settings:
  - trailing_stop_atr_multiplier (1.5x default)
  - trailing_activation_pips (10 pips default)
  - trailing_step_pips (5 pips minimum step)
- Created `src/trading/position_manager.py` - Full PositionManager class with:
  - TrackedPosition dataclass for position tracking state
  - TrailingStopUpdate dataclass for update recommendations
  - PositionDirection enum (BUY/SELL)
  - Position tracking with highest/lowest price history
  - Trailing stop calculation with activation threshold
  - Minimum step size enforcement
  - Take-profit level calculation
- Updated `src/trading/__init__.py` - Exported new classes
- Updated `src/data/capital_connector.py` - Added update_position() method for modifying SL/TP via API
- Updated `src/api/server.py`:
  - Added PositionManager initialization in lifespan
  - Added response models: TrackedPositionResponse, TrailingStopUpdateResponse, TrailingStopConfigResponse
  - Added request models: AddPositionRequest, UpdateTrailingStopRequest
  - `/api/trailing-stop-config` - Get trailing stop configuration
  - `/api/track-position` POST - Add position to tracker
  - `/api/track-position/{deal_id}` DELETE - Remove position from tracker
  - `/api/tracked-positions` - List all tracked positions
  - `/api/tracked-position/{deal_id}` - Get single position status
  - `/api/update-trailing-stop` - Calculate and apply trailing stop update
  - `/api/update-all-trailing-stops` - Batch update all positions

**Patterns Discovered:**
- Trailing stops track highest/lowest price since entry
- Activation requires profit >= activation_pips before trailing begins
- Stop moves only in favorable direction (up for BUY, down for SELL)
- Minimum step prevents excessive API calls for small movements
- Capital.com uses PUT to /positions/{deal_id} for updates

**Notes:**
- PositionManager is in-memory; positions should be re-added after restart
- update_position calls Capital.com API with stopLevel/profitLevel
- Trailing distance = current_atr * trailing_atr_multiplier

### Iteration 4 - US-008: Partial Take-Profit Levels
**Completed:** 2026-01-18

**Changes Made:**
- Updated `src/trading/position_manager.py`:
  - Added calculate_partial_close_size() method
  - Added record_partial_close() method with size tracking
  - Added move_stop_to_breakeven() method
  - Added process_tp_hit() method for processing TP actions
  - Added get_partial_tp_config() method
- Updated `src/api/server.py` - Added partial TP endpoints:
  - `/api/partial-tp-config` - Get TP configuration
  - `/api/calculate-tp-levels` - Calculate 3 TP levels from ATR
  - `/api/setup-position-with-tp` - Track position with auto TP levels
  - `/api/check-tp-levels/{deal_id}` - Check and execute partial closes
  - `/api/check-all-tp-levels` - Batch check all positions
  - `/api/move-to-breakeven/{deal_id}` - Move stop to entry price

**Patterns Discovered:**
- TP levels: 1x ATR (50%), 2x ATR (30%), 3x ATR (20%)
- After TP1 hit: auto-move stop to breakeven
- Partial close uses same close_position API with size parameter
- Track remaining position size after each partial close

**Notes:**
- Default config: 50%/30%/20% at 1x/2x/3x ATR
- Breakeven move only happens when it improves the stop (no backwards movement)
- TP level tracking persists until position is removed
